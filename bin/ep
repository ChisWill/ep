#!/usr/bin/env php
<?php

declare(strict_types=1);

use Ep\Console\Application;
use Ep\Console\Factory;

(static function () {
    $cwd = getcwd();

    if (file_exists($cwd . '/ep.json')) {
        $options = json_decode(file_get_contents($cwd . '/ep.json'), true);
    } else {
        $message = "Could not find a ep.json file in {$cwd}" . PHP_EOL;
        fwrite(STDERR, $message);
        exit(1);
    }
    require($options['bootstrap']);
    unset($options['bootstrap']);

    if (!file_exists($options['config'])) {
        $message = "Unable to find config file in {$options['config']}" . PHP_EOL;
        fwrite(STDERR, $message);
        exit(1);
    }

    Ep::init(array_merge(
        $userConfig = require($options['config']),
        [
            'rootNamespace' => 'Ep',
            'commandDirAndSuffix' => 'Command',
            'actionSuffix' => 'Action',
            'defaultAction' => 'index'
        ]
    ));
    unset($options['config']);

    $options['common'] ??= [];
    $options['common']['userRootNamespace'] = $userConfig['rootNamespace'] ?? 'App';
    $request = Ep::getDi()->get(Factory::class)->createRequest();
    $request->setOptions($options);

    $exitCode = Ep::getDi()
        ->get(Application::class)
        ->withRequest($request)
        ->run();
    exit($exitCode);
})();
